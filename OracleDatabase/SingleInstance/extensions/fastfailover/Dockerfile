# LICENSE UPL 1.0
#
# Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.
#
# ORACLE DOCKERFILES PROJECT
# --------------------------
# This is the Dockerfile for Oracle Database with Fast Fail Over support
#
# REQUIREMETNS FOR THIS IMAGE
# ----------------------------------
# Any release of prebuilt oracle/database base docker image
#
# HOW TO BUILD THIS IMAGE
# -----------------------
#
# Run:
#      $ docker build -t <extended_image_name> . --build-arg BASE_IMAGE=18.3.0-ee
#

ARG BASE_IMAGE=oracle/database:19.3.0-ee
FROM ${BASE_IMAGE}

# Extn name
ARG EXTENSION_NAME=fastfailover

# Environment variables required for this build (do NOT change)
# -------------------------------------------------------------
ENV ORACLE_SID=ORCLCDB \
    STARTUP_FILE=startUp.sh \
    SHUT_DB_FILE=shutDown.sh \
    LOCKING_SCRIPT=lock.py \
    SWAP_LOCK_FILE=swapLocks.sh \
    CHECK_DB_LOCK_FILE=checkDBLockStatus.sh

# Turn on dnfs
RUN cd $ORACLE_HOME/rdbms/lib && make -f ins_rdbms.mk dnfs_on

# Updated Health Check
HEALTHCHECK --interval=1m --start-period=30m \
   CMD "$ORACLE_BASE/$CHECK_DB_LOCK_FILE" >/dev/null || exit 1

# backup original runOracle
RUN mv "$ORACLE_BASE/$RUN_FILE" "$ORACLE_BASE/$RUN_FILE.$EXTENSION_NAME" && \
    ln -s "$ORACLE_BASE/$STARTUP_FILE" /home/oracle/ && \
    ln -s "$ORACLE_BASE/$SHUT_DB_FILE" /home/oracle/

# Copy updated scripts to support fastfailover
COPY  --chown=oracle:dba $RUN_FILE $START_FILE $STARTUP_FILE $SHUT_DB_FILE $LOCKING_SCRIPT $CHECK_DB_LOCK_FILE $ORACLE_BASE/
COPY  --chown=oracle:dba $SWAP_LOCK_FILE $ORACLE_BASE/scripts/setup/

# Set perms and append a call to main runOracle
RUN chmod ug+x $ORACLE_BASE/*.sh && sync && \
    echo -e "\n. $ORACLE_BASE/$RUN_FILE.$EXTENSION_NAME" >> "$ORACLE_BASE/$RUN_FILE"
